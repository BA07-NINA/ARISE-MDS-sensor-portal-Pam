{% extends 'base.html' %} {% block content %} {% include 'navbar.html' %}

<style>
  .hovertooltip {
    position: relative;
    display: inline-block;
  }

  /* Tooltip text */
  .tooltiptext {
    width: 120px;
    background-color: black;
    color: #fff;
    text-align: center;
    padding: 5px 0;
    border-radius: 6px;
    position: absolute;
    z-index: 1;
  }

  .tooltiptext.tooltipright {
    top: -5px;
    left: 105%;
  }

  .card {
    max-width: 15rem;
    width: 15rem;
    max-height: 20rem;
    cursor: pointer;
  }

  .modal {
    display: block;
    background-color: #5050506e;
  }

  .detail-table {
    width: fit-content;
    margin: auto;
  }

  .extra-info-table {
    padding-inline: 0;
  }

  .pagination .page-input {
    height: 100%;
    width: 4rem;
    border-left-style: none;
    border-width: thin;
    border-color: gray;
    padding-inline: 0.3rem;
  }

  .pagination .page-description {
    border: gray;
    border-block-style: solid;
    border-block-width: thin;
  }

  .pagination .page-count {
    padding-top: 0.5rem;
    padding-inline: 1rem;
  }

  .pagination .button-left {
    border-top-right-radius: 0%;
    border-bottom-right-radius: 0%;
  }

  .pagination .button-right {
    border-top-left-radius: 0%;
    border-bottom-left-radius: 0%;
  }

  .detail-modal .modal-header {
    background: steelblue;
    padding: 0.1rem;
    color: whitesmoke;
  }

  .detail-modal .paginator-button {
    --bs-btn-hover-color: white;
    --bs-btn-hover-bg: transparent;
    --bs-btn-border-color: transparent;
    --bs-btn-hover-border-color: transparent;
    --bs-btn-active-bg: transparent;
    --bs-btn-color: #ffffffbf;
    --bs-btn-active-color: #ffffffbf;
  }

  .detail-modal .paginator-button.disabled {
    border-color: transparent;
  }

  .detail-modal .close-button {
    --bs-btn-close-hover-opacity: 1 !important;
    --bs-btn-close-opacity: 0.5 !important;
  }

  .detail-modal .paginator-arrow {
    font-weight: bolder;
    font-size: 2rem !important;
    margin-bottom: 0.25rem !important;
  }

  .card.highlighted {
    padding: 7px !important;
    border-width: 2px !important;
    --bs-border-opacity: 1;
    border-color: rgba(var(--bs-dark-rgb), var(--bs-border-opacity)) !important;
  }

  .ts-control {
    padding-top: 1.625rem !important;
    padding-bottom: 0.625rem !important;
    font-size: 1rem !important;
  }

  .ts-control input,
  .ts-wrapper {
    color: black;
    cursor: text !important;
  }

  .was-validated :invalid ~ .form-text .invalid-feedback,
  .is-invalid ~ .form-text .invalid-feedback {
    display: inline;
    font-weight: bold;
  }

  .form-floating > .form-control-plaintext ~ label::after,
  .form-floating > .form-control:focus ~ label::after,
  .form-floating > .form-control:not(:placeholder-shown) ~ label::after,
  .form-floating > .form-select ~ label::after {
    background-color: transparent;
  }

  [x-cloak] {
    display: none !important;
  }
</style>

<div class="container-lg">
  <div x-data="allData">
    <div id="search-form-div">
      <form
        class="row gy-2 gx-3 mb-3 align-items-center"
        x-data="FormData"
        @submit.prevent="formSubmit"
        @reset.prevent="formReset"
        id="search-form"
      >
        <div class="col-lg-5">
          <div class="form-floating">
            <input
              name="search"
              id="search"
              class="form-control"
              placeholder=""
              x-model="formSearch"
            />
            <label for="search">Search</label>
          </div>
        </div>

        <div class="col-lg-2">
          <div class="form-floating">
            <select
              class="form-control form-select"
              name="is_active"
              id="select-is_active"
              placeholder=""
              x-model="formIsActive"
            >
              <option :selected="formIsActive === ''" value=""></option>
              <option :selected="formIsActive === 'True'" value="True">
                True
              </option>
              <option :selected="formIsActive === 'False'" value="False">
                False
              </option>
            </select>
            <label for="select-is_active">Deployment active?</label>
          </div>
        </div>

        <div class="col-lg-2">
          <div class="form-floating">
            <select
              class="form-control-lg form-select"
              name="site"
              id="select-site"
              placeholder=""
              x-model="formSite"
            >
              <option value=""></option>
              <template x-for="(site, index) in siteData">
                <option
                  x-bind:value="site['id']"
                  x-text="site['short_name']"
                ></option>
              </template>
            </select>
            <label for="select-site">Site</label>
          </div>
        </div>

        <div class="col-lg-2">
          <div class="form-floating">
            <select
              class="form-control-lg form-select"
              name="data_type"
              id="select-datatype"
              placeholder=""
              x-model="formDataType"
            >
              <option value=""></option>
              <template x-for="(datatype, index) in typeData">
                <option
                  x-bind:value="datatype['id']"
                  x-text="datatype['name']"
                ></option>
              </template>
            </select>
            <label for="select-datatype">Device type</label>
          </div>
        </div>

        <div class="col-lg-2 col-sm-6">
          <div class="form-floating">
            <input class="form-control" type="datetime-local" form-control"
            id="start_date" name="deploymentStart__gte" x-model="formStartDt">
            <label for="start_date">Deployment started after</label>
          </div>
        </div>

        <div class="col-lg-2 col-sm-6">
          <div class="form-floating">
            <input class="form-control" type="datetime-local" form-control"
            id="end_date" name="deploymentEnd__lte" x-model="formEndDt">
            <label for="end_date">Deployment ended before</label>
          </div>
        </div>

        <div class="col-lg-2">
          <div class="form-floating">
            <input
              class="form-control"
              name="page_size"
              type="number"
              min="1"
              max="100"
              step="5"
              x-model.number="pageSize"
            />
            <label for="page_size">Results per page</label>
          </div>
        </div>

        <div class="col col-lg-5 col-sm-12">
          <div class="gap-2 mx-auto">
            <button class="btn btn-primary btn-lg my-sm-1 col-sm-12 col-lg-2">
              Search
            </button>
            <input
              type="reset"
              class="btn btn-danger btn-lg my-sm-1 col-sm-12 col-lg-2"
            />
            <div class="float-lg-end">
              <button
                class="btn btn-success btn-lg my-sm-1 col-sm-12 col-lg-auto"
                x-on:click.prevent="setModalData(true,true,true)"
              >
                Add new deployment
              </button>
            </div>
          </div>
        </div>

        <input
          name="page"
          class="d-none"
          type="number"
          x-model.number="pageNum"
        />
        <input
          name="id"
          class="d-none"
          id="deployment"
          placeholder=""
          x-model="formId"
        />

        <!-- <input name="project" class="d-none" id="project"  placeholder="" x-model="formProject"> -->
        <input
          name="device"
          class="d-none"
          id="device"
          placeholder=""
          x-model="formDevice"
        />
      </form>
    </div>

    <div
      id="page-controls"
      x-show="isReady === false | (isReady === true && returnedData['results']!=null) "
    >
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          <li class="page-item">
            <a
              class="btn btn-outline-primary button-left"
              aria-label="Previous"
              x-on:click="if(returnedData['previous']!=null){ pageNum-=1;}"
              :class="{'btn-outline-dark disabled':returnedData['previous']==null}"
            >
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          <li class="page-item">
            <input
              name="pagination-page"
              class="page-input"
              type="number"
              min="1"
              x-bind:max="totalPages"
              x-model.number.lazy="pageNum"
            />
          </li>
          <li class="page-item page-description">
            <div
              class="text-center align-middle page-count"
              x-text="`of ${totalPages}`"
            ></div>
          </li>
          <li class="page-item">
            <a
              class="btn btn-outline-primary button-right"
              aria-label="Next"
              x-on:click="if(returnedData['next']!=null){ pageNum+=1;}"
              :class="{'btn-outline-dark disabled':returnedData['next']==null}"
            >
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        </ul>
      </nav>
      <div class="text-center align-middle">
        <span
          x-show="isReady === true && returnedData['results']!=null && returnedData['results'].length>0"
          x-text="`${objectRangeMin} - ${objectRangeMax} of ${returnedData['count']}`"
          x-cloak
        ></span>
        <span
          x-show="isReady === true && returnedData['results']!=null && returnedData['results'].length===0"
          x-cloak
        >
          No results</span
        >
      </div>
    </div>

    <div
      id="detail-modal"
      class="modal"
      role="dialog"
      x-show="showModal === true; $el.scrollTo({top: 0, behavior: 'instant'});"
      x-transition
      @click.self="showModal=false; formId=''"
      aria-labelledby="modalLabel"
      x-cloak
    >
      <div class="modal-dialog modal-lg detail-modal">
        <div class="modal-content shadow">
          <div class="modal-header" x-data="detailModalData">
            <a
              class="btn btn-outline-light paginator-button modal-title"
              aria-label="Previous"
              x-on:click="openCardDetail($event,cardIndex,-1)"
              :class="{'disabled': (!isReady|createNew)||checkLeftDisabled()}"
              x-cloak
            >
              <h5 class="paginator-arrow" aria-hidden="true">&laquo;</h5>
            </a>

            <h5 class="modal-title" id="detailTitle">
              <a
                class="text-reset text-decoration-none"
                :href="modalData['detail_url']"
                x-text="modalData[titleKey]"
              ></a>
            </h5>

            <div class="hovertooltip">
              <a
                id="copyButton"
                class="btn btn-outline-light paginator-button modal-title ms-2"
                x-on:click="navigator.clipboard.writeText(modalData['detail_url']); tooltipText = 'Copied address to clipboard'; tooltipWait=true; "
                x-on:mouseover.self="if(!tooltipWait){tooltip = true; tooltipText = 'Copy address to clipboard'}"
                x-on:mouseleave.self="tooltip = false; tooltipWait = false"
                x-data="{tooltip:false,tooltipText:'', tooltipWait:false}"
                :class="{'disabled': (!isReady | createNew)}"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  class="bi bi-clipboard"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"
                  />
                  <path
                    d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"
                  />
                </svg>

                <span
                  class="tooltiptext tooltipright"
                  x-show="tooltip"
                  x-text="tooltipText"
                ></span>
              </a>
            </div>

            <a
              class="btn btn-outline-light paginator-button modal-title"
              aria-label="Edit"
              x-on:click="editDetail ? editDetail=false : editDetail=true"
              :class="{'disabled': (!isReady)||editDetail}"
              x-cloak
            >
              Edit
            </a>

            <button
              type="button"
              class="btn-close btn-close-white close-button"
              data-dismiss="modal"
              aria-label="Close"
              @click.prevent="showModal=false; formId=''; editDetail=false"
            ></button>
            <a
              class="btn btn-outline-light paginator-button modal-title ms-1"
              aria-label="Next"
              x-on:click="openCardDetail($event,cardIndex,+1)"
              :class="{'disabled': (!isReady|createNew)||checkRightDisabled()}"
              x-cloak
            >
              <h5 class="paginator-arrow" aria-hidden="true">&raquo;</h5>
            </a>
          </div>
          <div class="modal-body">
            <div x-show="editDetail===true && isReady === true">
              <form
                @submit.prevent="detailformSubmit"
                id="detailForm"
                novalidate="True"
                class="row gy-2 gx-3 mb-3 align-items-center"
              >
                <input name="id" class="d-none" id="post-id" placeholder="" />

                <div class="form-floating">
                  <input
                    name="deploymentID"
                    class="form-control"
                    id="post-deployment"
                    placeholder=""
                    required
                  />
                  <label for="post-deployment">deployment ID</label>
                  <div class="form-text">
                    ID for your deployment.
                    <div class="invalid-feedback"></div>
                  </div>
                </div>

                <div class="form-floating">
                  <select
                    class="form-control-lg form-select"
                    name="device_type"
                    id="post-datatype"
                    placeholder=""
                    required
                  >
                    <option value=""></option>
                    <template x-for="(datatype, index) in typeData">
                      <option
                        x-bind:value="datatype['name']"
                        x-text="datatype['name']"
                      ></option>
                    </template>
                  </select>
                  <label for="post-datatype">Device type</label>
                  <div class="form-text">
                    Device type of your deployment
                    <div class="invalid-feedback"></div>
                  </div>
                </div>

                <div class="form-floating">
                  <input
                    name="device_n"
                    class="form-control"
                    id="post-device_n"
                    placeholder="1"
                    value="1"
                  />
                  <label for="post-device_n">number</label>
                </div>

                <div class="form-floating">
                  <select
                    class="form-control-lg form-select"
                    name="project"
                    id="post-project"
                    placeholder=""
                    multiple
                  >
                    <option value=""></option>
                    <template x-for="(project, index) in projectData">
                      <option
                        x-bind:value="project['projectID']"
                        x-text="project['projectName']"
                      ></option>
                    </template>
                  </select>
                  <label for="post-project">Project</label>
                  <div class="form-text">
                    Deployment project.
                    <div class="invalid-feedback"></div>
                  </div>
                </div>

                <div class="form-floating">
                  <select
                    class="form-control-lg form-select"
                    name="site"
                    id="post-site"
                    placeholder=""
                    required
                  >
                    <option value=""></option>
                    <template x-for="(site, index) in siteData">
                      <option
                        x-bind:value="site['short_name']"
                        x-text="site['name']"
                      ></option>
                    </template>
                  </select>
                  <label for="post-site">Site</label>
                  <div class="form-text">
                    Deployment site. New sites can be added.
                    <div class="invalid-feedback"></div>
                  </div>
                </div>

                <div class="form-floating">
                  <select
                    class="form-control-lg form-select"
                    name="device"
                    id="post-device"
                    placeholder=""
                    required
                  ></select>
                  <label for="post-device">Device</label>
                  <div class="form-text">
                    Deployment device.
                    <div class="invalid-feedback"></div>
                  </div>
                </div>

                <div class="form-floating">
                  <input
                    class="form-control"
                    step="0.001"
                    x-bind:value="nativeTZ(new Date())"
                    type="datetime-local"
                    id="post-start_date"
                    name="deploymentStart"
                    required
                  />
                  <label for="post-start_date">Deployment started</label>
                  <div class="form-text">
                    Date and time deployment starts.
                    <div class="invalid-feedback"></div>
                  </div>
                </div>

                <div class="form-floating">
                  <select
                    class="form-control-lg form-select dropdownTimeZone"
                    id="post-start_date-tz"
                    name="deploymentStart_TZ"
                  ></select>
                  <label>Timezone</label>
                </div>

                <div class="form-floating">
                  <input
                    class="form-control"
                    step="1"
                    type="datetime-local"
                    id="post-end_date"
                    name="deploymentEnd"
                  />
                  <label for="post-end_date">Deployment ended</label>
                  <div class="form-text">
                    Date and time deployment ends.
                    <div class="invalid-feedback"></div>
                  </div>
                </div>

                <div class="form-floating">
                  <select
                    class="form-control-lg form-select dropdownTimeZone"
                    id="post-end_date-tz"
                    name="deploymentEnd_TZ"
                  ></select>
                  <label>Timezone</label>
                </div>

                MAP GOES here EXTRA INFO GOES HERE

                <div class="d-grid gap-2 d-md-block mx-auto">
                  <button class="btn btn-primary btn-lg">Save</button>
                  <button
                    class="btn btn-danger btn-lg"
                    x-on:click.prevent="if(createNew){showModal=false}; editDetail=false;"
                  >
                    Cancel
                  </button>
                </div>
              </form>
            </div>

            <div
              id="detail-display"
              x-show="editDetail===false && isReady===true"
            >
              <table class="table detail-table">
                <tbody>
                  <template x-for="(value, key) in modalData" :key="key">
                    <template x-if="!hideKeys.includes(key)">
                      <tr>
                        <th scope="row" x-text="`${key}`"></th>
                        <template x-if="key != 'extra_info'">
                          <td
                            x-text="(timeKeys.includes(key)&&value!=null) ? dtFormat.format(value) : value"
                          ></td>
                        </template>
                        <template x-if="key == 'extra_info'">
                          <td>
                            <div class="extra-info-table">
                              <table
                                class="table table-sm table-striped mb-0 align-middle text-center"
                              >
                                <tbody>
                                  <template
                                    x-for="(e_iValue, e_iKey) in value"
                                    :key="e_iKey"
                                  >
                                    <tr>
                                      <th scope="row" x-text="`${e_iKey}`"></th>
                                      <td x-text="`${e_iValue}`"></td>
                                    </tr>
                                  </template>
                                </tbody>
                              </table>
                            </div>
                          </td>
                        </template>
                      </tr>
                    </template>
                  </template>
                </tbody>
              </table>
            </div>

            <div
              id="detail-loading-div"
              class="text-center"
              x-show="isReady === false"
              style="padding-block: 10rem; height: 40rem"
            >
              <div
                class="spinner-border"
                role="status"
                style="width: 4rem; height: 4rem"
              ></div>
              <span style="display: block">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="results-grid"
      x-show="isReady === true & returnedData['results']!=null "
    >
      <div class="row row-cols-1 row-cols-md-2" x-cloak>
        <template x-for="(deployment, index) in returnedData['results']">
          <div
            class="card m-2 p-2"
            @mouseover="card_highlighted = true"
            @mouseleave="card_highlighted = false"
            @click.prevent="openDetail($event)"
            x-data="cardData(index)"
            x-bind:id="`card_${index}`"
            :class="{'highlighted shadow':card_highlighted, 'text-white bg-secondary':!deployment.is_active } "
          >
            <template x-if="deployment.last_imageURL">
              <img class="card-img" x-bind:src="deployment.last_imageURL" />
            </template>
            <template x-if="!deployment.last_imageURL">
              <svg
                class="bd-placeholder-img card-img"
                width="100%"
                height="140"
                xmlns="http://www.w3.org/2000/svg"
                role="img"
                aria-label="Placeholder: Image cap"
                preserveAspectRatio="xMidYMid slice"
                focusable="false"
              >
                <title>Placeholder</title>
                <rect width="100%" height="100%" fill="#868e96"></rect>
              </svg>
            </template>
            <div class="card-body">
              <h6
                class="card-title"
                x-text="`${deployment.deployment_deviceID}`"
              ></h6>
              <p class="card-text" x-text="`${deployment.site}`">
                <small class="text-muted"></small>
              </p>
            </div>
          </div>
        </template>
      </div>
    </div>

    <div
      id="loading-div"
      class="text-center"
      x-show="isReady === false"
      style="padding-block: 1rem"
    >
      <div
        class="spinner-border"
        role="status"
        style="width: 4rem; height: 4rem"
      ></div>
      <span style="display: block">Loading...</span>
    </div>
  </div>
</div>

<script>
  function cardData(index) {
    return {
      card_index: index,
      card_highlighted: false,
      openDetail(e) {
        this.openCardDetail(e, this.card_index, 0);
      },
    };
  }

  function detailModalData() {
    return {
      checkLeftDisabled() {
        let hasData = this.returnedData["results"] != null;
        let lessThanZero = this.cardIndex - 1 < 0;
        let pageOne = this.pageNum == 1;

        return hasData && lessThanZero && pageOne;
      },
      checkRightDisabled() {
        let hasData = this.returnedData["results"] != null;
        let beyondLength =
          this.cardIndex + 1 >= this.returnedData["results"].length;
        let beyondCount =
          this.objectRangeMin + this.cardIndex + 1 > this.returnedData["count"];

        return hasData && beyondLength && beyondCount;
      },
    };
  }

  function setInvalidFeedback(responseData = null) {
    let form = document.getElementById("detailForm");
    let formData = new FormData(form);
    let allFormKeys = formData.keys();
    let keys;
    if (!responseData) {
      form.classList.add("was-validated");
    } else {
      console.log(responseData)
      keys = Object.keys(responseData);
      form.classList.remove("was-validated");
    }

    for (const key of allFormKeys) {
      console.log(key);
      let input = form.querySelector(`[name=${key}]`);
      console.log(input);
      if (input) {
        let invalidFeedback =
          input.parentNode.querySelector(".invalid-feedback");
        
          if (!responseData) {
            input.classList.remove('is-invalid')
            input.classList.remove('is-valid')
            if (invalidFeedback) {
            if (input.required) {
              invalidFeedback.innerHTML = "This field is required";
            } else {
              invalidFeedback.innerHTML = "";
            }
          }
          } else {
            if(keys.includes(key)){
              if (invalidFeedback) {
                invalidFeedback.innerHTML = responseData[key]
              }
              input.classList.add('is-invalid')
            }else{
              input.classList.add('is-valid')
            }
          }
        
      }
    }
  }

  //from backend
  //const datatype = 'deployment'
  const modelType = "deployment";
  //const titleKey = 'deployment_deviceID'
  const titleKey = "deployment_deviceID";
  //const hideKeys
  const hideKeys = [
    "id",
    "device_type_id",
    "device_id",
    "site_id",
    "project_id",
    "owner",
    "managers",
    "combo_project",
    "last_imageURL",
    "detail_url",
  ];

  const timeKeys = [
    "created_on",
    "modified_on",
    "recording_dt",
    "deploymentStart",
    "deploymentEnd",
  ];
  loadTimeZoneList();

  // Inititalise main DOM
  document.addEventListener("alpine:init", () => {
    Alpine.data("FormData", () => ({
      async init() {
        this.formReset();
        console.log("form init");
        await this.getSites();
        await this.getDataTypes();
        this.formSearch = this.urlQuery.get("search") || "";
        this.formIsActive = this.urlQuery.get("is_active") || "";
        this.formStartDt = this.urlQuery.get("deploymentStart__gte") || "";
        this.formEndDt = this.urlQuery.get("deploymentEnd__lte") || "";
        this.formId = this.urlQuery.get("id") || "";
        this.formProject = this.urlQuery.get("project") || "";
        this.formDevice = this.urlQuery.get("device") || "";
        this.$nextTick(() => {
          this.refreshData();
          this.prepareDetailForm();
        });
        console.log(this.urlQuery);
        document.querySelectorAll("#search-form").forEach((formElement) => {
          formElement.addEventListener("reset", (event) => {
            event.target
              .querySelectorAll(".tomselected")
              .forEach((tomselectedElement) => {
                tomselectedElement.tomselect.clear();
              });
          });
        });
      },
      formReset() {
        this.formSearch = "";
        this.formIsActive = "";
        this.formDataType = "";
        this.formStartDt = "";
        this.formEndDt = "";
        this.formSite = "";
        this.formId = "";
        this.formProject = "";
        this.formDevice = "";
      },
      formSubmit() {
        pageNum = 1;
        this.$nextTick(() => {
          this.refreshData(this.$event);
        });
      },
      async getSites() {
        this.formSite = this.urlQuery.get("site") || "";
        let url = `api/site/`;
        let api_response_data = await getData(url);
        this.siteData = api_response_data;
        this.$nextTick(() => {
          new TomSelect("#select-site", {
            allowEmptyOption: true,
            hidePlaceholder: false,
            items: [this.formSite],
            sortField: {
              field: "text",
              direction: "asc",
            },
          });
        });
      },
      async getDataTypes() {
        this.formDataType = this.urlQuery.get("data_type") || "";
        let url = `api/datatype/`;
        let api_response_data = await getData(url);
        this.typeData = api_response_data;
        this.$nextTick(() => {
          new TomSelect("#select-datatype", {
            allowEmptyOption: true,
            hidePlaceholder: false,
            items: [this.formDataType],
            sortField: {
              field: "text",
              direction: "asc",
            },
          });
        });
      },
    }));

    Alpine.data("allData", () => ({
      urlQuery: new URLSearchParams(location.search),
      showModal: false,
      editDetail: false,
      createNew: false,
      pageNum: 1,
      pageSize: 1,
      returnedData: [],
      modalData: {},
      totalPages: 1,
      objectRangeMin: 0,
      objectRangeMax: 25,
      cardIndex: 0,
      isReady: false,
      siteData: [],
      typeData: [],
      projectData: [],
      deviceData: [],
      deviceDataType: 0,
      init() {
        console.log("main init");
        this.showModal =
          (this.urlQuery.get("detail") || "false").toLowerCase() == "true";
        this.cardIndex = Number(this.urlQuery.get("detail_index")) || 0;
        this.pageNum = Number(this.urlQuery.get("page")) || this.pageNum;
        this.pageSize = Number(this.urlQuery.get("page_size")) || this.pageSize;
        this.$watch("pageNum", (value, oldValue) => {
          console.log(`${oldValue} ${value}`);
          let pageChange = this.clampPages();
          console.log(`page change from watch ${pageChange}`);
          if (pageChange) {
            this.$nextTick(() => {
              this.refreshData();
            });
          }
        });
        this.$watch("showModal", (value) => this.setSearchURL());
        this.$watch("cardIndex", (value) => this.setSearchURL());
      },
      async prepareDetailForm() {
        let deviceselect = new TomSelect("#post-datatype", {
          allowEmptyOption: false,
          hidePlaceholder: false,
          sortField: {
            field: "text",
            direction: "asc",
          },
        });

        new TomSelect("#post-site", {
          allowEmptyOption: false,
          hidePlaceholder: false,
          createOnBlur: true,
          create: true,
          persist: false,
          sortField: {
            field: "text",
            direction: "asc",
          },
        });

        let url = `api/project/`;
        let api_response_data = await getData(url);
        this.projectData = api_response_data;

        this.$nextTick(() => {
          new TomSelect("#post-project", {
            allowEmptyOption: true,
            hidePlaceholder: false,
            maxItems: null,
            sortField: {
              field: "text",
              direction: "asc",
            },
          });
          new TomSelect("#post-device", {
            allowEmptyOption: false,
            hidePlaceholder: false,
            sortField: {
              field: "text",
              direction: "asc",
            },
          });
          deviceselect.on("change", () => {
            this.getDetailDevices();
          });
          document.querySelectorAll("#detailForm").forEach((formElement) => {
            formElement.addEventListener("reset", (event) => {
              event.target
                .querySelectorAll(".tomselected")
                .forEach((tomselectedElement) => {
                  if (
                    tomselectedElement.classList.contains("dropdownTimeZone")
                  ) {
                    console.log(tomselectedElement);
                    tomselectedElement.tomselect.setValue(browserTimezone);
                    tomselectedElement.tomselect.sync();
                  } else {
                    tomselectedElement.tomselect.clear();
                  }
                });
            });
          });
        });
      },
      async getDetailDevices() {
        let deviceInput = document.querySelector("#post-device").tomselect;
        let newDeviceDataType = document.querySelector("#post-datatype").value;
        if (
          newDeviceDataType != "" &&
          newDeviceDataType != this.deviceDataType
        ) {
          console.log("refresh devices");
          this.deviceDataType = newDeviceDataType;
          deviceInput.clear();
          deviceInput.clearOptions();
          let url = `api/device/?type_name=${newDeviceDataType}`;
          let api_response_data = await getData(url);
          this.deviceData = api_response_data;

          for (device of this.deviceData) {
            deviceInput.addOption({
              text: `${device["deviceID"]} - ${device["name"]}`,
              value: device["deviceID"],
            });
          }
          deviceInput.refreshOptions(false);

          if (this.modalData && this.modalData["device"] != undefined) {
            deviceInput.addItem(this.modalData["device"]);
          }
          deviceInput.refreshItems();
        }
      },
      async openCardDetail(e, currCardIndex, offset = 0, open = true) {
        let pageChange = false;
        let resultslength = this.returnedData["results"].length;
        if (
          offset != 0 &&
          currCardIndex + offset > -1 &&
          currCardIndex + offset < resultslength
        ) {
          newIndex = currCardIndex + offset;
        } else if (
          offset == -1 &&
          currCardIndex + offset < 0 &&
          this.pageNum - 1 > 0
        ) {
          this.pageNum += offset;
          newIndex = this.pageSize - 1;
          pageChange = true;
        } else if (
          offset == 1 &&
          currCardIndex + offset >= resultslength &&
          this.pageNum + 1 <= this.totalPages
        ) {
          console.log("increment page");
          this.pageNum += offset;
          newIndex = 0;
          pageChange = true;
        } else {
          newIndex = currCardIndex;
        }

        this.cardIndex = newIndex;
        if (pageChange == false) {
          this.setModalData();
        }
      },
      setModalData(open = true, edit = false, create = false) {
        if (!create) {
          //should check for results
          newModalData = this.returnedData["results"][this.cardIndex];
          let url = new URL(window.location.href);
          url.searchParams.set("detail", true);
          url.searchParams.set("detailIndex", 0);
          url.searchParams.set("id", newModalData["id"]);
          newModalData["detail_url"] = url.toString();

          //convert timezone to local timezone
          for (key of timeKeys) {
            if (key in newModalData) {
              let currentTime = newModalData[key];
              if (currentTime) {
                console.log(newModalData[key]);
                let dateTime = new Date(currentTime);
                console.log(dateTime);
                newModalData[key] = dateTime;
              }
            }
          }

          this.modalData = newModalData;
          let { elements } = document.querySelector("#detailForm");

          for ([key, value] of Object.entries(newModalData)) {
            const field = elements.namedItem(key);
            if (field && field.classList.contains("tomselected")) {
              field.tomselect.clear();
              let value_ids = newModalData[key];
              value_ids = value_ids ? [].concat(value_ids) : [];
              for (value_id of value_ids) {
                field.tomselect.addItem(value_id);
              }
              field.tomselect.refreshItems();
            } else if (field && value && timeKeys.includes(key)) {
              let newvalue = nativeTZ(value);
              elements
                .namedItem(`${key}_TZ`)
                .tomselect.addItem(getTimeZoneCode(value));
              field.value = newvalue;
            } else {
              field && (field.value = value);
              field && console.log(field);
              field && console.log(value);
              field && console.log(field.value);
            }
          }
        } else {
          this.resetPostForm();
          this.createNew = true;
        }
        if (edit) {
          document
            .querySelector("#detailForm")
            .classList.remove("was-validated");
          console.log("edit");
          this.editDetail = true;
        }
        if (open) {
          this.showModal = true;
          if (!create) {
            this.setSearchURL();
          }
        }
      },
      resetPostForm() {
        document.querySelector("#detailForm").classList.remove("was-validated");
        document.querySelector("#detailForm").reset();
        document.getElementById("post-start_date").value = nativeTZ(new Date());
        document
          .querySelector("#detailForm")
          .querySelectorAll(".tomselected")
          .forEach((tomselectedElement) => {
            if (tomselectedElement.classList.contains("dropdownTimeZone")) {
              console.log(tomselectedElement);
              tomselectedElement.tomselect.setValue(browserTimezone);
              tomselectedElement.tomselect.sync();
            }
          });

        this.modalData = {};
      },
      async refreshData(e) {
        if (e) {
          formData = new FormData(e.target);
        } else {
          formData = new FormData(document.getElementById("search-form"));
        }
        console.log(formData);
        let searchParams = new URLSearchParams(formData);
        let queryString = searchParams.toString();
        let apiURL = `api/${modelType}/?${queryString}`;
        this.returnedData = [];
        this.modalData = {};
        this.isReady = false;
        let api_response_data = await getData(apiURL);
        //check here for errors
        console.log(api_response_data);

        this.isReady = true;
        if (!("results" in api_response_data)) {
          api_response_data["results"] = [];
        }
        this.returnedData = api_response_data;
        if (this.returnedData["results"].length > 0) {
          this.setModalData((open = false));
        }
        this.getPages();
        this.setSearchURL(searchParams);
      },
      async detailformSubmit(e) {
        setInvalidFeedback();

        let formData = new FormData(e.target);
        console.log(formData);

        //client side validation
        if (!e.target.checkValidity()) {
          e.preventDefault();
          e.stopPropagation();
          return;
        }

        for ([key, value] of formData.entries()) {
          //append user selected timezone
          if (timeKeys.includes(key) && !(value === "")) {
            let tzcode = formData.get(`${key}_TZ`);
            console.log(key, `${key}_TZ`, tzcode);
            let offset = getOffset(tzcode, true);
            newTimeString = value + offset;
            formData.set(key, newTimeString);
          }
          //Delete empty fields
          if (value === "") {
            formData.delete(key);
          }
        }
        console.log(formData.entries());
        let method = "POST";
        let apiURL = `api/${modelType}/`;

        //PATCH if editing
        if (formData.get("id") != undefined) {
          apiURL += `${formData.get("id")}/`;
          method = "PATCH";
        }

        //get response
        let api_response_data = await SubmitData(apiURL, formData, method);

        console.log(api_response_data);

        if (!api_response_data["ok"]) {
          setInvalidFeedback(api_response_data);
        }
      },
      setSearchURL(searchParams) {
        if (!searchParams) {
          searchParams = new URLSearchParams(formData);
        }
        searchParams.set("detail", this.showModal);
        searchParams.set("detail_index", this.cardIndex);
        url = new URL(window.location.href);
        url.search = searchParams;
        history.pushState(null, document.title, url.toString());
      },
      getPages() {
        this.totalPages = Math.ceil(this.returnedData["count"] / this.pageSize);
        this.objectRangeMin = (this.pageNum - 1) * this.pageSize + 1;
        this.objectRangeMax = Math.min(
          this.objectRangeMin + this.pageSize - 1,
          this.returnedData["count"]
        );
      },
      clampPages() {
        this.getPages();
        if ((this.pageNum > this.totalPages) & (this.totalPages > 0)) {
          console.log("change page number from clamp");
          this.pageNum = this.totalPages;
          return false;
        } else if (this.pageNum < 1) {
          console.log("change page number from clamp");
          this.pageNum = 1;
          return false;
        }
        return true;
      },
    }));
  });
</script>

{% endblock %}
